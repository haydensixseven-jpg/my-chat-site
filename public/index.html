<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyatter / Quantum Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --glass: rgba(10, 10, 18, 0.7);
            --glass-strong: rgba(5, 5, 10, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #020617;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 40%);
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SCROLLBAR --- */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- UI COMPONENTS --- */
        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .glass-strong { background: var(--glass-strong); backdrop-filter: blur(40px); border: 1px solid var(--border); }
        
        .rainbow-text {
            background: linear-gradient(90deg, #ff4d4d, #f97316, #fbbf24, #4ade80, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .btn-glow {
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 0 25px var(--accent-glow); filter: brightness(1.1); }
        .btn-glow:active { transform: translateY(0px); }

        .input-dark {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            outline: none;
            transition: border 0.3s;
        }
        .input-dark:focus { border-color: var(--accent); }

        .post-card {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }
        .post-card:hover { background: rgba(255, 255, 255, 0.02); }

        .pfp-large { width: 100px; height: 100px; border-radius: 30%; object-fit: cover; border: 2px solid var(--accent); }
        .pfp-nav { width: 40px; height: 40px; border-radius: 12px; object-fit: cover; }
        .pfp-feed { width: 48px; height: 48px; border-radius: 14px; object-fit: cover; background: #1e293b; }

        /* --- TAGS --- */
        .my-tag { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2); padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .other-tag { color: #818cf8; font-weight: 700; }
        .dev-badge { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; }

        /* --- MODAL LOGIC --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        #notif-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; display: none; border: 2px solid #020617; }
    </style>
</head>
<body class="flex justify-center">

    <div id="auth-ui" class="fixed inset-0 z-[2000] flex items-center justify-center glass-strong">
        <div class="w-full max-w-[420px] p-8 rounded-[2.5rem] text-center">
            <h1 class="text-6xl mb-4 rainbow-text tracking-tighter">NYATTER</h1>
            <p class="text-slate-400 mb-10 text-sm font-medium tracking-widest uppercase">The Quantum Protocol</p>

            <div id="login-view" class="space-y-4">
                <input type="text" id="log-id" placeholder="Username or Email" class="w-full p-4 rounded-2xl input-dark">
                <input type="password" id="log-pass" placeholder="Password" class="w-full p-4 rounded-2xl input-dark">
                <button onclick="handleLogin()" class="w-full py-4 rounded-2xl btn-glow font-bold text-white uppercase tracking-wider">Establish Link</button>
                <p class="text-slate-500 text-sm">New to the grid? <button onclick="swapAuth()" class="text-indigo-400 font-bold">Register Identity</button></p>
            </div>

            <div id="signup-view" class="hidden space-y-4">
                <div class="flex justify-center mb-6">
                    <label class="cursor-pointer group relative">
                        <img id="signup-preview" src="https://via.placeholder.com/150/1e293b/ffffff?text=+" class="pfp-large shadow-2xl transition-all group-hover:scale-105">
                        <input type="file" id="signup-file" class="hidden" accept="image/*" onchange="previewImg(event, 'signup-preview')">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-[30%] opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="text-[10px] font-black uppercase">Upload PFP</span>
                        </div>
                    </label>
                </div>
                <input type="text" id="reg-user" placeholder="Username" class="w-full p-3 rounded-xl input-dark">
                <input type="email" id="reg-email" placeholder="Email Address" class="w-full p-3 rounded-xl input-dark">
                <input type="password" id="reg-pass" placeholder="Password" class="w-full p-3 rounded-xl input-dark">
                <button onclick="handleSignup()" class="w-full py-4 rounded-2xl btn-glow font-bold text-white uppercase tracking-wider">Initialize User</button>
                <p class="text-slate-500 text-sm">Already mapped? <button onclick="swapAuth()" class="text-indigo-400 font-bold">Back to Login</button></p>
            </div>
            
            <p id="auth-err" class="hidden mt-4 text-red-400 text-xs font-bold"></p>
        </div>
    </div>

    <div id="modal-notif" class="modal-overlay" onclick="closeModals()">
        <div class="w-full max-w-md glass-strong p-8 rounded-[3rem] shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-2xl font-black mb-6">Alert History</h2>
            <div id="notif-list" class="space-y-3 max-h-[400px] overflow-y-auto custom-scroll"></div>
        </div>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="w-full max-w-md glass-strong p-10 rounded-[3rem] shadow-2xl relative text-center">
            <button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-2xl font-black mb-8">Profile Synthesis</h2>

            <div class="flex justify-center mb-8">
                <label class="cursor-pointer group relative">
                    <img id="edit-preview" src="" class="pfp-large">
                    <input type="file" id="edit-file" class="hidden" accept="image/*" onchange="previewImg(event, 'edit-preview')">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-[30%] opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px] font-black uppercase">Change</span>
                    </div>
                </label>
            </div>

            <div class="space-y-4">
                <div class="text-left">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Update Callsign</label>
                    <input type="text" id="edit-user" class="w-full p-4 rounded-2xl input-dark mt-1">
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-2">Secure Passphrase</label>
                    <input type="password" id="edit-pass" placeholder="Enter new password" class="w-full p-4 rounded-2xl input-dark mt-1">
                </div>
                <button onclick="saveSettings()" class="w-full py-4 rounded-2xl btn-glow font-black text-white uppercase tracking-widest mt-4">Save Parameters</button>
            </div>
        </div>
    </div>

    <div id="app-ui" class="hidden w-full max-w-[1400px] h-screen flex relative">
        
        <aside class="w-[280px] flex flex-col p-8 border-r border-white/5 bg-slate-900/20">
            <div class="mb-12"><span class="text-2xl rainbow-text">NYATTER</span></div>
            
            <nav class="flex-1 space-y-2">
                <div class="flex items-center gap-4 px-6 py-4 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 text-white font-bold cursor-pointer">
                    <span>üè†</span> Feed
                </div>
                <div onclick="openNotifs()" class="relative flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 hover:text-white hover:bg-white/5 transition-all cursor-pointer">
                    <span>üîî</span> Notifications
                    <div id="notif-dot"></div>
                </div>
            </nav>

            <div onclick="openSettings()" class="p-4 rounded-[2rem] glass cursor-pointer group hover:border-indigo-500/50 transition-all">
                <div class="flex items-center gap-3">
                    <img id="nav-pfp" src="" class="pfp-nav border border-white/10 group-hover:rotate-6 transition-transform">
                    <div class="overflow-hidden">
                        <p class="font-bold text-sm truncate" id="nav-user"></p>
                        <div id="nav-dev" class="hidden"><span class="dev-badge">Core Admin</span></div>
                    </div>
                </div>
                <button onclick="logout()" class="w-full mt-4 py-2 text-[10px] font-black text-red-400/50 hover:text-red-400 uppercase tracking-widest transition-colors">Disconnect</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col border-r border-white/5 bg-black/20">
            <header class="p-6 glass border-x-0 border-t-0 flex justify-between items-center sticky top-0 z-50">
                <h2 class="text-xl font-black tracking-tight">GLOBAL STREAM</h2>
                <div class="text-[10px] font-black text-slate-500 bg-white/5 px-3 py-1 rounded-full border border-white/10">V4.0 QUANTUM</div>
            </header>

            <div class="flex-1 overflow-y-auto custom-scroll" id="feed-scroll">
                <div class="p-8 border-b border-white/5 bg-white/[0.01]">
                    <div class="flex gap-6">
                        <img id="comp-pfp" src="" class="pfp-feed shadow-xl">
                        <div class="flex-1">
                            <textarea id="post-input" placeholder="Broadcast to the network..." class="w-full bg-transparent text-xl outline-none resize-none h-24 pt-2 text-white placeholder-slate-700"></textarea>
                            <div id="post-preview" class="mb-4"></div>
                            
                            <div class="flex justify-between items-center pt-4 border-t border-white/5">
                                <label class="p-2 hover:bg-white/5 rounded-xl cursor-pointer transition-all text-xl">
                                    üñºÔ∏è<input type="file" class="hidden" accept="image/*" onchange="previewImg(event, 'post-preview-img')">
                                </label>
                                <button onclick="transmit()" class="px-10 py-3 rounded-full btn-glow font-black text-white text-xs uppercase tracking-widest">Transmit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="feed-list" class="divide-y divide-white/5"></div>
            </div>
        </main>

        <aside class="w-[340px] p-8 hidden lg:block bg-slate-900/10">
            <div class="glass rounded-[2.5rem] p-6 h-full flex flex-col">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-8 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-pulse"></span>
                    Network Directory
                </h3>
                <div id="user-list" class="space-y-4 overflow-y-auto custom-scroll flex-1 pr-2"></div>
                
                <div class="mt-8 pt-8 border-t border-white/5 text-center">
                    <p class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">Encrypted Terminal</p>
                </div>
            </div>
        </aside>

    </div>

    <script>
        let USER = null;
        let USER_DATA = {}; // Cache for {username: pfp}
        let TEMP_PFP = null;
        let IS_REPLYING = false;
        const DEV_NAME = "HaydenDev";

        // --- AUTH LOGIC ---
        function swapAuth() {
            document.getElementById('login-view').classList.toggle('hidden');
            document.getElementById('signup-view').classList.toggle('hidden');
            document.getElementById('auth-err').classList.add('hidden');
        }

        function previewImg(e, targetId) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const data = reader.result;
                if(targetId === 'post-preview-img') {
                    TEMP_PFP = data;
                    document.getElementById('post-preview').innerHTML = `<img src="${data}" class="w-full rounded-2xl mt-4 border border-white/10">`;
                } else {
                    document.getElementById(targetId).src = data;
                }
            };
            reader.readAsDataURL(file);
        }

        async function handleSignup() {
            const username = document.getElementById('reg-user').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-pass').value.trim();
            const pfp = document.getElementById('signup-preview').src;

            if(!username || !password) return showErr("Identity parameters missing.");

            const res = await fetch('/api/signup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, email, password, pfp })
            });
            const data = await res.json();
            if(data.error) return showErr(data.error);
            initSession(data.user);
        }

        async function handleLogin() {
            const identifier = document.getElementById('log-id').value.trim();
            const password = document.getElementById('log-pass').value.trim();

            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ identifier, password })
            });
            const data = await res.json();
            if(data.error) return showErr(data.error);
            initSession(data.user);
        }

        function showErr(msg) {
            const el = document.getElementById('auth-err');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        // --- SESSION LOGIC ---
        function initSession(user) {
            USER = user;
            localStorage.setItem('nyatter_session', JSON.stringify(user));
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('app-ui').classList.remove('hidden');
            
            // Set UI
            document.getElementById('nav-user').innerText = "@" + user.username;
            document.getElementById('nav-pfp').src = user.pfp;
            document.getElementById('comp-pfp').src = user.pfp;
            if(user.username === DEV_NAME) document.getElementById('nav-dev').classList.remove('hidden');

            startSync();
        }

        function startSync() {
            refresh();
            setInterval(() => { if(!IS_REPLYING) refresh(); }, 4000);
        }

        async function refresh() {
            await fetchUsers(); // Cache PFPs
            await fetchPosts();
            await fetchNotifs();
        }

        // --- POSTING & COMMANDS ---
        async function transmit() {
            const text = document.getElementById('post-input').value.trim();
            if(!text && !TEMP_PFP) return;

            const res = await fetch('/api/posts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: USER.username, text, img: TEMP_PFP })
            });
            const data = await res.json();

            // Check for Silent Admin Commands
            if(data.commandAction) {
                alert("System Command Executed: " + data.commandAction);
                if(data.commandAction === "WIPED_ALL") logout();
            }

            document.getElementById('post-input').value = "";
            document.getElementById('post-preview').innerHTML = "";
            TEMP_PFP = null;
            refresh();
        }

        async function sendReply(postId) {
            const input = document.getElementById(`reply-in-${postId}`);
            const text = input.value.trim();
            if(!text) return;

            await fetch('/api/posts/reply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: postId, user: USER.username, text })
            });
            IS_REPLYING = false;
            refresh();
        }

        // --- PROFILE SETTINGS ---
        function openSettings() {
            document.getElementById('edit-preview').src = USER.pfp;
            document.getElementById('edit-user').value = USER.username;
            document.getElementById('modal-settings').classList.add('active');
        }

        async function saveSettings() {
            const newUsername = document.getElementById('edit-user').value.trim();
            const newPassword = document.getElementById('edit-pass').value.trim();
            const newPfp = document.getElementById('edit-preview').src;

            const res = await fetch('/api/user/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    oldUsername: USER.username, 
                    newUsername, 
                    newPassword, 
                    newPfp 
                })
            });
            const data = await res.json();
            if(data.success) {
                localStorage.setItem('nyatter_session', JSON.stringify(data.user));
                location.reload();
            } else {
                alert(data.error);
            }
        }

        // --- DATA FETCHING ---
        async function fetchUsers() {
            const res = await fetch('/api/users');
            const users = await res.json();
            USER_DATA = {};
            users.forEach(u => USER_DATA[u.username] = u.pfp);

            document.getElementById('user-list').innerHTML = users.map(u => `
                <div class="flex items-center gap-3 group">
                    <img src="${u.pfp}" class="w-8 h-8 rounded-lg object-cover border border-white/10 group-hover:border-indigo-500">
                    <span class="text-xs font-bold text-slate-400 group-hover:text-white transition-colors">@${u.username}</span>
                </div>
            `).join('');
        }

        async function fetchPosts() {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            const list = document.getElementById('feed-list');

            list.innerHTML = posts.map(p => {
                const pfp = USER_DATA[p.user] || 'https://via.placeholder.com/150';
                return `
                <div class="p-8 post-card ${p.pinned ? 'bg-indigo-500/[0.03] border-l-2 border-l-amber-400' : ''}">
                    <div class="flex gap-6">
                        <img src="${pfp}" class="pfp-feed shadow-lg shrink-0">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-extrabold text-white">@${p.user}</span>
                                    ${p.user === DEV_NAME ? '<span class="dev-badge">Admin</span>' : ''}
                                    ${p.pinned ? '<span class="text-[10px] text-amber-400 font-black tracking-widest uppercase">Pinned</span>' : ''}
                                </div>
                                <div class="flex gap-4">
                                    ${(USER.username === DEV_NAME || USER.username === p.user) ? `
                                        <button onclick="deletePost('${p._id}')" class="text-[9px] font-black text-slate-600 hover:text-red-500 uppercase tracking-widest">Delete</button>
                                    ` : ''}
                                </div>
                            </div>
                            <p class="text-[15px] text-slate-300 leading-relaxed font-medium whitespace-pre-wrap">${parse(p.text)}</p>
                            ${p.img ? `<img src="${p.img}" class="w-full mt-4 rounded-3xl border border-white/10 shadow-2xl">` : ''}
                            
                            <div class="mt-6 space-y-4 pl-4 border-l border-white/5">
                                ${p.replies.map(r => `
                                    <div class="flex gap-3 text-sm">
                                        <img src="${USER_DATA[r.user] || ''}" class="w-6 h-6 rounded-md">
                                        <p class="text-slate-400"><span class="text-indigo-400 font-bold">@${r.user}</span> ${parse(r.text)}</p>
                                    </div>
                                `).join('')}
                                <div class="flex gap-3 pt-2">
                                    <input id="reply-in-${p._id}" 
                                        onfocus="IS_REPLYING=true" onblur="setTimeout(()=>IS_REPLYING=false, 200)"
                                        placeholder="Type a response..." 
                                        class="flex-1 bg-white/5 border border-white/5 rounded-xl px-4 py-2 text-xs outline-none focus:border-indigo-500">
                                    <button onclick="sendReply('${p._id}')" class="text-indigo-400 font-black text-[10px] uppercase">Reply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        async function fetchNotifs() {
            const res = await fetch(`/api/notifications/${USER.username}`);
            const data = await res.json();
            document.getElementById('notif-dot').style.display = data.length > 0 ? 'block' : 'none';
            document.getElementById('notif-list').innerHTML = data.map(n => `
                <div class="p-4 bg-white/5 rounded-2xl flex justify-between items-center border border-white/5">
                    <p class="text-sm"><b>@${n.fromUser}</b> tagged you</p>
                    <button onclick="clearNotif('${n._id}')" class="text-red-400 font-bold">‚úï</button>
                </div>
            `).join('') || '<p class="text-center text-slate-600 py-10">No signals detected.</p>';
        }

        // --- UTILS ---
        function parse(text) {
            return text.replace(/@(\w+)/g, (match, name) => {
                return `<span class="${name === USER.username ? 'my-tag' : 'other-tag'}">${match}</span>`;
            });
        }
        function openNotifs() { document.getElementById('modal-notif').classList.add('active'); }
        function closeModals() { 
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); 
        }
        function logout() { localStorage.clear(); location.reload(); }
        async function clearNotif(id) {
            await fetch('/api/notifications/clear', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) });
            refresh();
        }
        async function deletePost(id) {
            if(!confirm("Erase from history?")) return;
            await fetch('/api/posts/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, user: USER.username}) });
            refresh();
        }

        window.onload = () => {
            const session = localStorage.getItem('nyatter_session');
            if(session) initSession(JSON.parse(session));
        };
    </script>
</body>
</html>
